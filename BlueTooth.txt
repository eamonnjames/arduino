#include "thingProperties.h"
#include <ArduinoBLE.h>
#include <WiFi.h>

// BLE Service and Characteristic
BLEService helloService("180C"); // Custom service UUID
BLEStringCharacteristic helloCharacteristic("2A56", BLERead | BLENotify, 20); // Custom characteristic UUID

// Button setup
const int buttonPin = 2; // Change this to the pin your microswitch is connected to
bool lastButtonState = HIGH; // Assume pull-up resistor
bool messageSent = false;

// Callback when IoT Cloud connects
void onArduinoCloudConnect() {
  Serial.println("‚úÖ Connected to Arduino IoT Cloud!");
}

void setup() {
  // Initialize serial monitor
  Serial.begin(9600);
  delay(1500);

  // Initialize built-in LED pin
  pinMode(LED_BUILTIN, OUTPUT);

  // Initialize properties
  initProperties();

  // Start IoT Cloud connection
  ArduinoCloud.begin(ArduinoIoTPreferredConnection);

  // Wait until WiFi is connected
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\n‚úÖ WiFi connected!");
  Serial.print("IP address: ");
  Serial.println(WiFi.localIP());

  // Optional: set debug messages
  setDebugMessageLevel(2);
  ArduinoCloud.printDebugInfo();

   Serial.begin(9600);
  while (!Serial);

  pinMode(buttonPin, INPUT_PULLUP); // Use internal pull-up resistor

  if (!BLE.begin()) {
    Serial.println("BLE failed to start");
    while (1);
  }

  BLE.setLocalName("Nano33IoT");
  BLE.setAdvertisedService(helloService);

  helloService.addCharacteristic(helloCharacteristic);
  BLE.addService(helloService);

  helloCharacteristic.writeValue("Ready");

  BLE.advertise();
  Serial.println("BLE device 'Nano33IoT' is now advertising and ready to pair");
  
}

void loop() {
  // Keep IoT Cloud connection alive
  ArduinoCloud.update();

  BLEDevice central = BLE.central();

  if (central) {
    Serial.print("üîó Paired with central device: ");
    Serial.print(central.address());
    Serial.print(" (Name: ");
    Serial.print(central.localName());
    Serial.println(")");

    while (central.connected()) {
      bool currentButtonState = digitalRead(buttonPin);

      // Detect falling edge (button press)
      if (lastButtonState == HIGH && currentButtonState == LOW) {
        helloCharacteristic.writeValue("Fired");
        Serial.println("üö® Button pressed: Sent 'Fired'");
        messageSent = true;
      }

      // Reset messageSent flag when button is released
      if (currentButtonState == HIGH && messageSent) {
        messageSent = false;
      }

      lastButtonState = currentButtonState;
    }

    Serial.print("‚ùå Disconnected from central device: ");
    Serial.println(central.address());
  }
  
}
